# 使用指导书

## 工具介绍
openGauss数据迁移校验工具 （openGauss-tools-datachecker-performance），包含全量数据校验以及增量数据校验。

## 软件架构
全量数据校验，采用JDBC方式抽取源端和目标端数据，并将抽取结果暂存到kafka中，校验服务通过抽取服务从kafka中获取指定表的抽取结果，进行校验。最后将校验结果输出到指定路径的文件文件中。

增量数据校验，通过debezium监控源端数据库的数据变更记录，抽取服务按照一定的频率定期处理debezium的变更记录，对变更记录进行统计。将统计结果发送给数据校验服务。由数据校验服务发起增量数据校验，并将校验结果输出到指定路径文件。



## 环境要求

### 硬件要求

- 服务器数量：3台鲲鹏920服务器（2台用于数据库服务器，1台用于校验服务端，kafka服务）。
- 服务器硬件规格：
  - Memory：大于512GB。
  - CPU: Kunpeng-920 2600MHZ 128核
  - Free Disk：4块NVME硬盘，每块容量大于1TB。
  - 网卡：Hi1822千兆网卡，光纤互连。

### 软件要求

​	操作系统要求：openEuler-20.03-LTS（aarch64 架构）

​	JDK ： JDK11+

​	MYSQL：要求5.7+版本

​	openGauss：openGauss3.0.0

​	数据库配置建议使用高性能环境配置。

​	

```
关闭openGauss synchronize_seqscans参数 ：
gs_guc reload -D -c "synchronize_seqscans=off"
开启并行查询 query_dop，设置并行度为8，可以根据机器情况自行配置，最大64。
gs_guc reload -D -c "query_dop=8"

配置完成后需重启数据库。
```



## 部署方式

​	两台数据库服务器，分别安装mysql数据库和opengauss数据库

​	将校验工具抽取服务部署于数据库服务器

​	一台用于部署校验服务和kafka服务

## 使用步骤

**启动Zookeeper**

```
cd {path}/confluent-7.2.0
```

```
bin/zookeeper-server-start  etc/kafka/zookeeper.properties
或者
bin/zookeeper-server-start -daemon etc/kafka/zookeeper.properties
```

**启动Kafka**

```
bin/kafka-server-start etc/kafka/server.properties
或者
bin/kafka-server-start -daemon etc/kafka/server.properties
```



**校验服务启动配置** 

```
校验服务配置 修改application.yml文件
	server.port 为校验服务web端口，默认可不修改
	logging.config  设置校验服务日志路径为config/log4j2.xml文件绝对路径
	bootstrap-servers 为kafka工作地址，默认安装可不修改
	data.check.data-path 校验结果输出地址，默认配置可不修改
	data.check.source-uri 源端服务请求地址，默认配置可不修改
	data.check.sink-uri 目标端服务请求地址，默认配置可不修改
	data.check.core-pool-size 并发线程数设置，根据当前环境配置，可不修改（保留配置）
```

**源端服务启动配置**

```
源端服务配置 修改application-source.yml文件
	server.port 为源端抽取服务web端口，默认可不修改
	logging.config 设置校验服务日志路径为config/log4j2source.xml文件绝对路径
	spring.check.server-uri 校验服务请求地址，默认配置可不修改
	spring.extract.schema 当前校验数据schema，mysql 数据库名称
	spring.extract.core-pool-size 并发线程数设置，根据当前环境配置，可不修改（保留配置）
	bootstrap-servers 为kafka工作地址，默认安装可不修改
	
	数据源配置
	工具默认采用druid数据源，用户可以自定义配置连接池参数,可根据当前校验数据库任务数量（表数量）进行调整 
	initialSize: 5 默认初始连接大小
	minIdle: 10 默认最小连接池数量
	maxActive: 20 默认激活数据库连接数量
	
```

**目标端服务启动配置**

```
目标端服务配置 修改application-sink.yml文件
	server.port 为目标端抽取服务web端口，默认可不修改
	logging.config 设置校验服务日志路径为config/log4j2sink.xml文件绝对路径
	spring.check.server-uri 校验服务请求地址，默认配置可不修改
	spring.extract.schema 当前校验数据schema，opengauss schema名称
	spring.extract.core-pool-size 并发线程数设置，根据当前环境配置，可不修改（保留配置）
	bootstrap-servers 为kafka工作地址，默认安装可不修改
	
	数据源配置
	工具默认采用druid数据源，用户可以自定义配置连接池参数，可根据当前校验数据库任务数量（表数量）进行调整
	initialSize: 5 默认初始连接大小
	minIdle: 10 默认最小连接池数量
	maxActive: 20 默认激活数据库连接数量
```



**启动数据校验服务**

**后台启动命令**

```shell
nohup java -Dspring.config.additional-location=config/application-source.yml -jar datachecker-extract-0.0.1.jar --spring.profiles.active=source  >/dev/null 2>&1 &

nohup java -Dspring.config.additional-location=config/application-sink.yml -jar datachecker-extract-0.0.1.jar --spring.profiles.active=sink >/dev/null 2>&1 &

nohup java -Dspring.config.additional-location=config/application.yml -jar datachecker-check-0.0.1.jar >/dev/null 2>&1 &
```

**校验服务完全启动成功后，会自动发起校验请求。**



**备注：**

```
1、抽取服务在启动后，会自动加载数据库的表相关信息，如果数据量较大，则数据加载会比较耗时。
2、校验服务启动后，会检测抽取端的表数据信息是否加载完成，如果在一定时间内，未完成加载，则校验服务会自行退出。这时需要查询源端和宿端的表信息加载进度，通过日志信息查看加载进度。或者直接重新启动校验服务。
3、增量校验服务启动，需要修改源端配置文件\config\application-source.yml 中	debezium-enable:true并配置其他 debezium相关配置，服务启动即可开启增量校验服务
4、服务启动参数与部署方式，会对校验性能产生一定的影响。
   启动参数：校验服务和抽取进程 增加java虚拟机参数 -Xmx、 -Xms 参数设置（1G -10G）各进程参数保持一致即可
   启动参数增加元空间大小设置参考值：  -XX:MaxMetaspaceSize=1024M -XX:MetaspaceSize=1024M
   GC设置参考： -XX:+UseG1GC -XX:MaxGCPauseMillis=100 -XX:+ParallelRefProcEnabled
   部署方式：将抽取服务分别部署源端和目标端的数据库节点，校验服务和kafka可以部署在单独机器上。
 
```



## 校验性能测试设计

性能测试设计，要求满足如上所示 “**环境要求**”。

### 表设计

表包含数字，字符，日期，时间，枚举，文本，字符串多种格式，15个字段，表构建以及表数据构建采用sysbench进行批量构造。

```
CREATE TABLE `t_datacheck_templete` (
	`id` INT(10) UNSIGNED NOT NULL AUTO_INCREMENT,
	`c_int` INT(10) UNSIGNED NOT NULL DEFAULT '0',
	`c_char` CHAR(120) NOT NULL DEFAULT '' COLLATE 'utf8_general_ci',
	`c_pad` CHAR(60) NOT NULL DEFAULT '' COLLATE 'utf8_general_ci',
	`c_char2` CHAR(80) NOT NULL DEFAULT '' COLLATE 'utf8_general_ci',
	`c_varchar` VARCHAR(300) NOT NULL DEFAULT '' COLLATE 'utf8_general_ci',
	`c_date` DATE NOT NULL DEFAULT '2021-08-12',
	`c_timestamp` TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP COMMENT '当前时间',
	`c_time` TIME NULL DEFAULT NULL,
	`c_float` FLOAT(3,2) NULL DEFAULT NULL,
	`c_double` DOUBLE(5,4) NULL DEFAULT NULL,
	`c_decimal` DECIMAL(6,4) NULL DEFAULT NULL,
	`c_decimal2` DECIMAL(7,6) NULL DEFAULT NULL,
	`c_enum` ENUM('a','b','c','d') NULL DEFAULT NULL COLLATE 'utf8_general_ci',
	`c_mediumtxt` MEDIUMTEXT NULL DEFAULT NULL COLLATE 'utf8_general_ci',
	PRIMARY KEY (`id`) USING BTREE,
	INDEX `index_c_int_1` (`c_int`) USING BTREE
)
COLLATE='utf8_general_ci'
ENGINE=InnoDB
;


```



### 测试场景结果

校验工具性能测试，在高性能环境场景下，设置抽取服务和校验服务JVM启动参数，并对下列校验场景进行测试。

JVM参数如下：-Xmx5G -Xms5G -XX:MaxMetaspaceSize=1G -XX:MetaspaceSize=1G -XX:+UseG1GC

校验速率测试场景如下，基本达到校验速率70M /s

| 表数量  | 单表数据量 | 总大小(M) | 校验速率（M/s） |
| ------- | ---------- | --------- | --------------- |
| 1张表   | 500万      | 2817M     | 112M/s          |
| 5张表   | 100万      | 2818M     | 90M/s           |
| 10张表  | 50万       | 2818M     | 112M/s          |
| 25张表  | 20万       | 2819M     | 140M/s          |
| 50张表  | 10万       | 2824M     | 156M/s          |
| 100张表 | 5万        | 2825M     | 156M/s          |
| 200张表 | 2万        | 2838M     | 113M/s          |
| 250张表 | 2.5万      | 2836M     | 109M/s          |
| 500张表 | 1万        | 2844M     | 71M/s           |



JVM参数如下：-Xmx50G -Xms50G -XX:MaxMetaspaceSize=1G -XX:MetaspaceSize=1G -XX:+UseG1GC

校验速率测试场景如下，基本达到校验速率70M /s

| 表数量   | 单表数据量 | 总大小(M) | 校验速率（M/s） |
| -------- | ---------- | --------- | --------------- |
| 3张表    | 1亿        | 156G      | 115M/s          |
| 3000张表 | 10万       | 155G      | 174M/s          |



### **性能计算参考**

```
校验速率 = 源端数据库大小 / 校验时间  
数据库大小：参考如下方式
校验时间：数据校验完成后，会自动统计校验耗时（cost time），并在check.log日志中打印 .
```

**数据库大小查看命令参考**

```
mysql> select concat(round(sum(data_length/1024/1024),2),'MB') as data from information_schema.tables where table_schema='test';
+-----------+
| data      |
+-----------+
| 2757.81MB |
+-----------+
1 row in set (0.01 sec)


opengauss:
test_check=> \l+
                                                                    List of databases
    Name    |  Owner   | Encoding |   Collate   |    Ctype    |   Access privileges   |  Size   | Tablespace |                Description
------------+----------+----------+-------------+-------------+-----------------------+---------+------------+--------------------------------------------
 finance    | wangchao | UTF8     | en_US.UTF-8 | en_US.UTF-8 |                       | 13 MB   | pg_default |
 postgres   | wangchao | UTF8     | en_US.UTF-8 | en_US.UTF-8 |                       | 40 MB   | pg_default | default administrative connection database
 school     | wangchao | UTF8     | en_US.UTF-8 | en_US.UTF-8 |                       | 13 MB   | pg_default |
 template0  | wangchao | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/wangchao          +| 12 MB   | pg_default | default template for new databases
            |          |          |             |             | wangchao=CTc/wangchao |         |            |
 template1  | wangchao | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/wangchao          +| 12 MB   | pg_default | unmodifiable empty database
            |          |          |             |             | wangchao=CTc/wangchao |         |            |
 test_check | jack     | UTF8     | en_US.UTF-8 | en_US.UTF-8 |                       | 2847 MB | pg_default |
(6 rows)
```

**限制与约束**

```
JDK版本要求JDK11+
当前版本仅支持对源端MySQL，目标端openGauss数据校验
当前版本仅支持数据校验，不支持表对象校验
MYSQL需要5.7+版本
当前版本不支持地理位置几何图形数据校验
```

